<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <!-- <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" /> -->
		<!-- Removed device-width and device-height for iOS 7-->
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, target-densitydpi=device-dpi" />
        <!-- <link rel="stylesheet" type="text/css" href="css/blocks.css" /> -->
        <link rel="stylesheet" type="text/css" href="css/lobby.css" />
		<link href="css/stylefix.css" rel="stylesheet" />
        <!-- <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" /> -->
        
        <link href="styles/kendo.common.min.css" rel="stylesheet" />
        <link href="styles/kendo.default.min.css" rel="stylesheet" />
        <link href="styles/kendo.mobile.all.min.css" rel="stylesheet" />
        
        <link href="css/lobby-kendoui.css" rel="stylesheet" />
		<link href="css/iwe_icon_fonts.css" rel="stylesheet" />		
        <script src="js/jquery.min.js"></script>
        <!-- <script src="js/angular.min.js"></script> -->
        <script src="js/kendo.all.min.js"></script>
		<script src="js/jquery.maksedinput.min.js"></script>
		<!-- Bootstrap -->
		<link href="css/bootstrap.min.css" rel="stylesheet"> <!-- media="screen" -->
		
        <title>Lobby</title>
    </head>
    <body class="scrollable">
	
	<div id="questions-body" data-role="view" data-title=" " data-layout="checklayout" data-show="DisplayResponses" >
        <div style="padding-left:10px;">
        <span class="span-question-text" style="margin:0;">Please answer the following questions:</span>
	        <ul data-role="listview" data-style="inset" id="ulResponses" data-type="group">
			</ul>
            <div class="row-fluid FormIndentation" id="divQuestions" style="padding-left:15px;">
			  
			</div>
            </div>
        </div>
        <div id="divCompleteResponseView" data-role="view" data-title="" data-layout="ResponseDetailsLayout" data-show="DisplayQuestionResponses">
			<div class="ResponseDetailContainer">
				<span id="spanQuestionText"></span>
				
			</div>
		</div>
        
		<div id="Products" data-role="view" data-init="mobileListViewLocalFiltering" data-title="Products">
			<header data-role="header">
				<div data-role="navbar">
					<span data-role="view-title"></span>
					<a data-align="right" data-role="button" class="nav-button" href="#/">Index</a>
				</div>
			</header>

			<ul id="local-filterable-listview"></ul>
		</div>
		
		<!-- <div id="LocalListView" data-role="view" data-init="mobileListViewLocal" data-layout="ResponseDetailsLayout"> -->
		<div id="LocalListView" data-role="view" data-show="mobileListViewIncremental" data-layout="ResponseDetailsLayout">
			<!-- <ul id="listView"></ul> -->
			<span id="spanQuestionText1"></span>
			<div id="divFilterWrap">
				<input type="search" id="txtSearchOrg"></input>
			</div>
			
			<div style="overflow-y:scroll;height:70vh">
				<ul id="local-filterable-listview1"></ul>
			 </div>
		</div>
		
		<div data-role="layout" data-id="checklayout">
            <header data-role="header">
                <!-- <div data-role="navbar">
                    <span data-role="view-title"></span>
                    <!-- <a data-align="right" data-role="button" class="nav-button" href="#/">Index</a> 
					<div id="div_header" class="header-div">
						<div class="HeaderLogoContainer"><img src="img/logo-ucla.png" class="HeaderLogo"/><span id="NameText" class="header-text"></span></div>
					</div>
                </div> -->
                <div data-role="header" style="background-color:#3284bf">
                    <div id="div_header_cancel" class="header-div">
                        <div class="cancel-btn-div">
                            <a class="cancel-link cancelLinkFix" data-role="button" data-click="CancelResponses">Cancel</a>
                        </div>
                        <div style="clear:both;"></div>
                    </div>
                    
                </div>
            </header>
        </div>
        
		<div data-role="layout" data-id="ResponseDetailsLayout">
            <!-- <header data-role="header" style="background-color:#3284bf"> -->
			<div data-role="header" style="background-color:#3284bf">               
				<!-- <div id="div_header" class="header-div" >
					<div>
						<a data-role="button" data-align="left" class="link-button" href="#">Cancel</a>
						<span id="DeptName" class="header-text"></span>						
						<a data-role="button" class="link-button">Close</a>
					</div>
					
				</div> -->
			<div data-role="header">
			   <div id="div_header_cancel" class="header-div">
                    <div class="cancel-btn-div">
					<a href="#" class="cancel-link cancelLinkFix" data-role="button">Cancel</a>                					
					</div>
					<!--<div style="text-align:center;position:relative;float:left;width:86%"><span id="DeptNameResponseDetail" class="header-text"></span></div>-->
					<div style="text-align:right;position:relative;float:right;width:7%">
					<a class="cancel-link cancelLinkFix" data-role="button" data-click="CollectResponse">Done</a>
                    <div style="clear:both;"></div>
				</div>
				</div>
				
			</div>
            <!-- </header> -->
        </div>
		
		<!-- modal to display alert messages -->
		<div data-role="modalview" id="modalviewAlert" class="ReasonsAlert">
				<div data-role="header">
					<div data-role="navbar">
						<span>Alert</span>
						<a data-click="HideNativeDialog" data-role="button" data-align="right" style="background:none;color:#3284bf;">Close</a>
					</div>
				</div>
				<div class="modalContent">
					<span id="spanAlertMessage" class="AlertText"></span> 
			    </div>
		</div>
		
        
        <!-- ** blocks.js interfering when trying to use app variable of kendo ui after the page load **-->
		<!-- <script type="text/javascript" src="js/blocks.js"></script> -->        
		
		<script type="text/javascript" src="js/reasons.js"></script>
        <script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="phonegap.js"></script>
        <!-- TODO: Remove index.js reference, if not needed -->
		<script type="text/javascript" src="js/index.js"></script>
		
		<!--Bootstrap-->
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.maksedinput.min.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
		
        <script type="text/javascript">
		var app1, paramQuestionId, eventQuestions, otherPrefix = "[Other] - ";
			
		window.onload = function(){			
			//Adding useNativeScrolling property interferes with mobileListView
			app1 = new kendo.mobile.Application(document.body);

			$("#DeptName").text(localStorage.getItem("deptname"));
			
			$('.textbox-true').click(function(){
										$(this).parent().parent().append("<div><input type='text' id='" + $(this).attr('id') + "-txtother' class='temp'/></div>")
									 });
		};

		function mobileListViewLocalFiltering() {
		var dataSource = new kendo.data.DataSource({ data: getResponses() });
        $("#local-filterable-listview").kendoMobileListView({
            dataSource: dataSource,
            template: "#:name #",						
           /* filterable: {
                field: "name",
				operator: "contains"
            },*/
            virtualViewSize: 100, // this configuration is needed to determine the items displayed, since the datasource does not (and should not) have paging set.
            endlessScroll: true
        });
    }
		
		function mobileListViewLocal() {        
		var dataSource = new kendo.data.DataSource({ data: getOrganizations() });		
        $("#local-filterable-listview1").kendoMobileListView({
				dataSource: dataSource,
				//template: "#:name #",						
				template: "<label>#: Text# <input type='radio' name='input-" + paramQuestionId + "' id='#:ID#' class='textbox-#:OpensTextbox#'/></label>",
				filterable: {
					field: "Text",
					operator: "contains"
				}
                ,virtualViewSize: 100, // this configuration is needed to determine the items displayed, since the datasource does not (and should not) have paging set.
				endlessScroll: true
			});
		}
		
		var defaultPageSize = 20;
		function mobileListViewIncremental(){
			var allOrgs;
			var fromIdx = 0, toIdx = 0;
			
			if(allOrgs == undefined){
				//add all formatted orgs into localStorage
				var allOrgsFormatted = [];
				var liText = "";
				var dataSource = getOrganizations();
				
				for(var idx = 0; idx < dataSource.length; idx++)
				{
					if(idx < defaultPageSize){
						liText = "<li><label>"+ dataSource[idx].Text + "<input type='radio' name='input-" + paramQuestionId + "' id="+ dataSource[idx].ID +"' class='textbox-"+ dataSource[idx].OpensTextbox+ "'/></label></li>";
					}
					else
					{
						liText = "<li><label class='km-listview-label'>"+ dataSource[idx].Text + "<input type='radio' name='input-" + paramQuestionId + "' id="+ dataSource[idx].ID +"' class='textbox-"+ dataSource[idx].OpensTextbox+ " km-widget km-icon km-check'/></label></li>";
					}
					allOrgsFormatted.push(liText);
				}
				localStorage.setItem("allOrgs", allOrgsFormatted);
			}
			
			var totalLi = dataSource.length;
			var liCount = $('input[name="input-' + paramQuestionId + '"]').length;
			console.log('total count: ' + totalLi + ' in list..' + liCount);
			
			if(liCount > 0 && liCount < totalLi)
			{
					
			}
			else if (liCount == 0)
			{
				fromIdx = 0;
				toIdx = defaultPageSize;
				
				for (var idx = fromIdx; idx < toIdx; idx++)
				{
					$("#local-filterable-listview1").append(allOrgsFormatted[idx]);
				}
			}
			
			if (toIdx < totalLi && $('#liLoadMore').attr('id') == undefined){
				$("#local-filterable-listview1").append("<li id='liLoadMore' data-click='LoadMoreOrgs' class='LoadMore'><a data-role='button' data-click='LoadMoreOrgs' onclick='LoadMoreOrgs'>Load more...</a></li>");
			}
			
			$("#local-filterable-listview1").kendoMobileListView();
			$('#liLoadMore').bind('click', LoadMoreOrgs);
			$('#liLoadMore a').removeClass("km-listview-link");
			
			//Find the span id in scroll container
			var spanIdInScrollContainer = $('div.km-scroll-container #spanQuestionText1').attr('id');
			if(spanIdInScrollContainer != undefined)
			{
				$('#spanQuestionText1').parent().next().next().after($('#spanQuestionText1').next().next())
			}
		}
		
		function LoadMoreOrgs(e){
			//total number of Organizations
			var allOrgs = localStorage.getItem("allOrgs").split('</li>,');
			var fromIdx, toIdx, liCount;
			var totalLi = allOrgs.length;
			$('#liLoadMore').remove();
			liCount = $('input[name="input-' + paramQuestionId + '"]').length;
			fromIdx = liCount + 1;
			toIdx = liCount + defaultPageSize + 1;
			
			for (var idx = fromIdx; idx < toIdx; idx++)
			{
				//$("#local-filterable-listview1").append(allOrgsFormatted[idx]);
				//$("#local-filterable-listview1").append('<li><a href="#" class="km-listview-link" data-role="listview-link">'+ 'Dynamic Item' + '</a></li>');
				$("#local-filterable-listview1").append(allOrgs[idx]);
			}
			
			if (toIdx < totalLi && $('#liLoadMore').attr('id') == undefined){
				$("#local-filterable-listview1").append("<li id='liLoadMore' data-click='LoadMoreOrgs' class='LoadMore'><a data-role='button' data-click='LoadMoreOrgs' onclick='LoadMoreOrgs'>Load more...</a></li>");
				$('#liLoadMore').removeClass("km-listview-link").bind('click', LoadMoreOrgs);
			}
			//$("#local-filterable-listview1").kendoMobileListView();
		}

		function DisplayResponses(e){
				eventQuestions = JSON.parse(localStorage.getItem("questions"));
                var q_array = eventQuestions.Questions;
		if (q_array.length < 3)
		{ //Display one-column layout like display if there're only 2 questions or less. This will be needed for most of the lobby which has single question
				for(var i = 0; i < q_array.length; i++) {
				
                    var question = q_array[i];
                    //$('#questions-body div[data-role="content"]').append('<form class="form"><div class="control reasons-form" id="div_reason_list_' + question.ID +'"><label id="i-4" style="margin-bottom:3%;"><span id="' + question.ID +'_prompt"></span></label></div><div class="control">');
                    $('#questions-body div[data-role="content"]').append('<div class="control reasons-form" id="div_reason_list_' + question.ID +'"><label id="i-4" style="margin-bottom:3%;"><span id="' + question.ID +'_prompt"></span></label></div><div class="control">');
					//$('#' + question.ID + '_prompt').text(question.QuestionText);
                    $("#ulResponses").append("<li><span class='span-question-text'>" + question.QuestionText + "</span><div><ul id='ul_" + question.ID + "'></ul></div></li>");
                    
                    var inputtype = "checkbox";
                    
                    
                    if(question.ResponsesType == "1")
                    {
                        inputtype = "radio";
                    }
                    else if(question.ResponsesType == "2")
                    {
                        inputtype = "checkbox";
                    }
                    else if(question.ResponsesType == "3")
                    {
                        inputtype = "selectbox";
                        //SetUpComboBox(question.ID);
                    }
                    else if (question.ResponsesType == "4")
                    {
                        inputtype = "textbox";
                        //$('#div_reason_list_' + question.ID).append('<label><input type="' + inputtype +'" aria-labelledby="i-4" id="' + question.Responses[0].ID  + '" name="txt_' + question.ID + '" class="horizontal-center textbox small-textbox" style="width:93% !important;"></label>');
                    }
					else if (question.ResponsesType == "5")
                    {
                        inputtype = "numerictextbox";
                        //$('#div_reason_list_' + question.ID).append('<label><input type="' + inputtype +'" aria-labelledby="i-4" id="' + question.Responses[0].ID  + '" name="txt_' + question.ID + '" class="horizontal-center textbox small-textbox" style="width:93% !important;"></label>');
                    }

					var responses = question.Responses;					
					
					e.view.content.append($('<ul ></ul>'));

                    var viewID = e.view.id;                    
                    if(inputtype == "radio" || inputtype == "checkbox")
                    {
                        e.view.element.find("#ul_" + question.ID).kendoMobileListView({
                            //dataSource: responses,
                            //template: "id: #: id# with text: #: text#",
                            template: "<label>#: Text# <input type='" + inputtype + "' name='input-" + question.ID + "' id='#:ID#' class='textbox-#:OpensTextbox#'/></label>",
                        });

                        e.view.element.find("#ul_" + question.ID).data("kendoMobileListView").append(responses);
                    }
                    else if(inputtype == "selectbox")
                    {
						//Please select/start typing...						
						var defaultEntry = JSON.parse('{"ID":-1,"Text":"","Description":"Select","OpensTextbox":false}');
						responses.unshift(defaultEntry);
                        $("#ul_" + question.ID).append("<li></li>");
                        e.view.element.find("#ul_" + question.ID + " > li").kendoComboBox({
                                                   dataTextField: "Text",
                                                   dataValueField: "ID",
                                                   dataSource: responses,
                                                   filter: "contains",
                                                   suggest: true,
                                                   index: 0
                                                   });
												   
						$('#ul_8 input').attr('placeholder', 'Please select/start typing an organization...');						
                    }
                    else if(inputtype == "textbox")
                    {
						var txtId = responses[0].ID;
                        $("#ul_" + question.ID).append('<input type="text" value="" name="' + question.ID + '" id="' +  txtId + '" class="TextBox" />');
					}
					else if(inputtype == "numerictextbox")
                    {
						var txtId = responses[0].ID;
                        $("#ul_" + question.ID).append('<input type="number" value="" name="' + question.ID + '" id="' +  txtId + '" class="TextBox" />');
                    }
				
			}//for
			
			//Continue button
			$("#ulResponses").append('<li><a data-role="button" id="continueBtn" class="button">Continue</a></li>');
			e.view.element.find("#continueBtn").kendoMobileButton({click: SubmitReasons});
		}	
		else{
			BuildQuestionsAndResponses(q_array, e);
		}
			
		
		}

		function BuildQuestionsAndResponses(q_array, e){
		var canConstructQuestions = $("#divQuestions").children().length == 0;
		
		if (canConstructQuestions){
		    var collectedResponses = [], response, responseId;
		    //localStorage.setItem("CollectedResponses", responsesObj);
			for(var i = 0; i < q_array.length; i++) {
                    var question = q_array[i];   
					var responses = question.Responses;
                    //$('#questions-body div[data-role="content"]').append('<div class="control reasons-form" id="div_reason_list_' + question.ID +'"><label id="i-4" style="margin-bottom:3%;"><span id="' + question.ID +'_prompt"></span></label></div><div class="control">');					
                    //$("#ulResponses").append("<li><span class='span-question-text'>" + question.QuestionText + "</span><div><ul id='ul_" + question.ID + "'></ul></div></li>");
                    
					collectedResponses.push({QuestionId: question.ID, ReasonId: "", ReasonDetails: "", OtherReasonId: ""});
					
					var divContainer = '<div id="div'+ question.ID + '" class="QuestionAndResponseContainer">{0}</div>';
					var divQuestionText = '<div class="span8"> <span class="QuestionText"><br/>' + question.QuestionText + '</span> </div>';
					//add ul view here and append here..
					var divResponse = '<div class="span4" id="divResponse'+ question.ID + '"><ul id="ul_' + question.ID + '"></ul></div>';
					//divResponse = '<div class="span8" id="divResponse'+ question.ID + '"><ul id="ul_' + question.ID + '" data-role="listview" data-style="inset" class="ListViewContainer"><li><span id="spanResponseText' + question.ID + '">Response Text..</span></li></ul> <a data-role="button"  id="btnResponseDetail_' + question.ID + '" data-questionid="' + question.ID + '"><span style="float:right">&gt;</span></a></div>';
					//var responseText = GetResponseText(question.ID);
					var responseText = "Required";
					if(responseText == undefined) responseText = "";
					divResponse = '<div class="span4 ResponseContainer" id="divResponse'+ question.ID + '" displayListView="false"><span id="spanResponseText' + question.ID + '" class="Response Required">' + responseText + '</span> <a data-role="button"  id="btnResponseDetail_' + question.ID + '" data-questionid="' + question.ID + '" class="ResponseDetailButton"><span><i class="icon-chevron-sign-right"></i></span></a></div>';
					
					var divQuestionAndResponse = "";
                    var inputtype = "checkbox";
                    
                    if(question.ResponsesType == "1")
                    {
                        inputtype = "radio";
						divResponse = '<div class="span4 ResponseContainer" id="divResponse'+ question.ID + '" displayListView="false"><span id="spanResponseText' + question.ID + '" class="Response Required">' + responseText + '</span> <a data-role="button"  id="btnResponseDetail_' + question.ID + '" data-questionid="' + question.ID + '" class="ResponseDetailButton"><span><i class="icon-chevron-sign-right"></i></span></a></div>';
                    }
                    else if(question.ResponsesType == "2")
                    {
                        inputtype = "checkbox";
						divResponse = '<div class="span4 ResponseContainer" id="divResponse'+ question.ID + '" displayListView="false"><span id="spanResponseText' + question.ID + '" class="Response Required">' + responseText + '</span> <a data-role="button"  id="btnResponseDetail_' + question.ID + '" data-questionid="' + question.ID + '" class="ResponseDetailButton"><span><i class="icon-chevron-sign-right"></i></span></a></div>';
                    }
                    else if(question.ResponsesType == "3")
                    {
                        inputtype = "selectbox";
                        //SetUpComboBox(question.ID);
						divResponse = '<div class="span4 ResponseContainer" id="divResponse'+ question.ID + '" displayListView="true"><span id="spanResponseText' + question.ID + '" class="Response Required">' + responseText + '</span> <a data-role="button"  id="btnResponseDetail_' + question.ID + '" data-questionid="' + question.ID + '" class="ResponseDetailButton"><span><i class="icon-chevron-sign-right"></i></span></a></div>';
                    }
                    else if (question.ResponsesType == "4")
                    {
                        inputtype = "textbox";
						//divResponse = '<div class="span8" id="divResponse'+ question.ID + '" style="padding-top:0.9%"><ul id="ul_' + question.ID + '" data-role="listview" data-style="inset" class="ListViewContainer"><li><input type="text" id="txt_' + question.ID + '"></input></li></ul></div>';
						//divResponse = '<div class="span4" id="divResponse'+ question.ID + '" style="padding-top:0.9%;"><input type="text" id="txt_' + question.ID + '"  class="TextBox FloatRight" placeholder="Required"></input></div>';
						responseId = responses[0].ID;
						divResponse = '<div class="span4" id="divResponse'+ question.ID + '" style="padding-top:0.9%;"><input type="text" name="' + question.ID + '" id="' +  responseId + '"  class="TextBox FloatRight" placeholder="Required"></input></div>';
                    }
					else if (question.ResponsesType == "5")
                    {
                        inputtype = "textbox";
						//divResponse = '<div class="span8" id="divResponse'+ question.ID + '" style="padding-top:0.9%"><ul id="ul_' + question.ID + '" data-role="listview" data-style="inset" class="ListViewContainer"><li><input type="text" id="txt_' + question.ID + '"></input></li></ul></div>';						
						//divResponse = '<div class="span4" id="divResponse'+ question.ID + '" style="padding-top:0.9%;"><input type="text" id="txt_' + question.ID + '"  class="TextBox FloatRight" placeholder="Required"></input></div>';
						responseId = responses[0].ID;

						//type number						
						divResponse = '<div class="span4" id="divResponse'+ question.ID + '" style="padding-top:0.9%;"><input type="number" name="' + question.ID + '" id="' +  responseId + '" min="1" max="9999" oninput="MaxLengthCheck(this)" class="TextBox FloatRight" placeholder="Required"></input></div>';
                    }

					divQuestionAndResponse = divQuestionText + divResponse;
                    $('#divQuestions').append(divContainer.replace('{0}', divQuestionAndResponse));
					
					if(question.ResponsesType != "4" && question.ResponsesType != "5")
					{
						$('#divResponse'+ question.ID).click(ShowResponsePage);
					}
					
					if(question.ResponsesType == "5"){
						//allow only numbers on keypress event
						$('#'+ responseId).bind('keypress',PopulateNumbers);
						//disable paste
						$('#'+ responseId).bind("paste",function(e) {  
							 e.preventDefault();  
						}); 
					}
					
					
					var responses = question.Responses;					
					var responsePlaceHolder = "<span>response text</span> <span style='float:right'>&gt;</span>";
					e.view.content.append($('<ul ></ul>'));

                    var viewID = e.view.id;                    
					
                    if(inputtype == "radio" || inputtype == "checkbox" || inputtype == "selectbox")
                    {
						e.view.element.find("#btnResponseDetail_" + question.ID).kendoMobileButton(); //, question:12 | {click: ShowResponsePage}
						$("#btnResponseDetail_" + question.ID).addClass('ResponseDetailButton');
                    }
					else if(inputtype == "textbox")
					{
						e.view.element.find("#ul_" + question.ID).kendoMobileListView();
					}
			}//for
			
			localStorage.setItem("CollectedResponses", JSON.stringify(collectedResponses));
			//Continue button
			$("#divQuestions").append('<div id="divContinueButton" class="ContinueButtonPadding"><a data-role="button" id="continueBtn" class="button">Continue</a></div>');
			e.view.element.find("#continueBtn").kendoMobileButton({click: SubmitReasons});
		  }
		  else{
			//reset controls
			//$('div.QuestionAndResponseContainer span.Response').empty()
			//load responses for the questions
			var question, responseType, responseText;
			for(var i = 0; i < q_array.length; i++) {
				question = q_array[i];
				responseType = GetResponseControlType(question.ResponsesType);
				
				if(responseType != "textbox" && responseType != "checkbox")
				{
					//get response text for the question, if made
					responseText = GetResponseText(question.ID);					
					if(responseText != ""){//if user provided a response, remove error highlight
						$('#divResponse'+ question.ID).removeClass("Error");
						//populate in the readonly control
						$('#spanResponseText'+ question.ID).text(responseText).removeClass("Required");
					}
					else
					{
						$('#spanResponseText'+ question.ID).text("Required").addClass("Required");
					}
				}
				else if(responseType == "checkbox"){
					//display number of responses selected
					var collResponses = JSON.parse(localStorage.getItem("CollectedResponses"));

                    if (collResponses != undefined){
                        //responseId = GetUserResponseId(collResponses, question.ID);
						responseId = GetUserResponse(question.ID, "Id");
                    }

					var responseCount = 0;
					
					if (responseId != ""){
						responseCount = responseId.split(",").length;
					}
					
					if (responseCount > 0){//if user provided a response, remove error highlight
						$('#spanResponseText'+ question.ID).text(responseCount + " selected").removeClass("Required");
						$('#divResponse'+ question.ID).removeClass("Error");
					}
					else
					{
						$('#spanResponseText'+ question.ID).text("Required").addClass("Required");
					}
				}
				else if(responseType == "textbox")
				{
					responseText = $('#txt_' +question.ID).val();
					if(responseText != ""){//if user provided a response, remove error highlight
						$('#txt_' +question.ID).removeClass("Error");
					}
				}
			}
		  }
		}
		
		//function to check length of input. If greater than 4, first 4 chars are retained
		//TODO: To make length check for number textbox generic, maxlength need to be configured in DB
		function MaxLengthCheck(ctl){
							if (ctl.value.length > 4)
								{ctl.value = ctl.value.slice(0,4); }
						}
		
		//Function to allow only numbers into the text field
		function PopulateNumbers(e)
		{
			var code = e.keyCode || e.which;
			if(code < 48 || code > 57){
			
				e.preventDefault();
			}
		}
		
		function GetResponseText(questionId)
		{
			var allQuestions, responseId, question, responses, retResponseText;
			responseText = "";
			var collResponses = JSON.parse(localStorage.getItem("CollectedResponses"));
			if(eventQuestions == undefined){ //if eventQuestions does not exist, parse it. eventQuestions should have been initialized in DisplayResponses methods			
				eventQuestions = JSON.parse(localStorage.getItem("questions"));
			}
		  
			allQuestions = eventQuestions.Questions;

            if (collResponses != undefined){
                //responseId = GetUserResponseId(collResponses, questionId);
				responseId = GetUserResponse(questionId, "Id");
            }
			
			//loop through all the questions to find the response text for the input questionId
			for (var idx = 0; idx < allQuestions.length; idx++)
			{//loop through all the questions
				question = allQuestions[idx];
				if(question.ID == questionId){
					responses = question.Responses;
					for (var idx1 = 0 ; idx1 < responses.length; idx1++)
					{//loop through all the responses for the passed in question id
						if(responses[idx1].ID == responseId)
						{//if response id matches, get the reponse text
							retResponseText = responses[idx1].Text;
							if(responses[idx1].OpensTextbox == true)
							{
								//get user entered text
								retResponseText = GetUserResponse(questionId, "OtherText");
							}
							break;
						}
					}
				}
			}
			
			if (retResponseText == undefined) retResponseText = "";
			return retResponseText;
		}
		
		//Get the user response id(s) fors the question
		function GetUserResponseId(collResponses, questionId){
			var retResponseId;
			
			//loop through all the responses that were collected to find the response id that was made
			for(var idx = 0; idx < collResponses.length; idx++)
			{
				if(collResponses[idx].QuestionId == questionId){
					retResponseId = collResponses[idx].ReasonId;
					break;
				}
			}
			
			return retResponseId;
		}
		
		function xGetUserResponse(collResponses, questionId, propName){
			var retResponse, userResponseObj;
			
			//loop through all the responses that were collected to find the response id that was made
			for(var idx = 0; idx < collResponses.length; idx++)
			{
				if(collResponses[idx].QuestionId == questionId){
					//retResponseId = collResponses[idx].ReasonId;
					userResponseObj = collResponses[idx];
					break;
				}
			}
			
			if (userResponseObj != undefined){
				switch(propName){
					case "ReasonId":
						retResponse = collResponses[idx].ReasonId;
						break;
					case "OtherReason":
						retResponse = collResponses[idx].ReasonDetails;
						break;
				}
			}
			
			return retResponse;
		}
		
		//Display view where response for the question will be displayed
		function ShowResponsePage(e){
			//Get QuestionId for which responses need to be displayed			
			var params = "", canDisplayListView = false;
			
			if(e.button == 0){
				paramQuestionId = $(this).attr('id');
				paramQuestionId = paramQuestionId.replace("divResponse", "");
				canDisplayListView = $(this).attr('displayListView');
			}
			else{
				params = e.button.data();
				//Passing parameter to listview/view is not supported. So, param value is stored in a global variable
				paramQuestionId = params.questionid;
			}
			
			if (canDisplayListView == "true"){
				//load a different view to display response in a listview. Loading the dynamic listview response in 'divCompleteResponseView' had some rendering problems
				app1.navigate("#LocalListView");
			}
			else
			{
				app1.navigate("#divCompleteResponseView");
			}
		}
		
		//Display responses associated with the question
		//This function is used to display responses for a question where response count is more than 2
		function DisplayQuestionResponses(e){
			//add delay before displaying all the response controls to prevent accidental touch on controls
			$('#divCompleteResponseView').addClass('DisplayNone');
			window.setTimeout(function(){
				$('#divCompleteResponseView').removeClass('DisplayNone')
			}, 300);
		 
		  var responseForQuestion, allQuestions, question, questionText, responseControlTypeId, responseControlType;
		  
		  $("#DeptNameResponseDetail").text(localStorage.getItem("deptname"));
		  if(eventQuestions == undefined){ //if eventQuestions does not exist, parse it. eventQuestions should have been initialized in DisplayResponses methods			
			eventQuestions = JSON.parse(localStorage.getItem("questions"));
		  }
		  
		  allQuestions = eventQuestions.Questions;
		  
		  for (var idx = 0; idx < allQuestions.length; idx++){
				question = allQuestions[idx];
			   if(question.ID == paramQuestionId)
			   {
				 //get responses
				 responseForQuestion	= question.Responses;
				 responseControlTypeId 	= question.ResponsesType;
				 questionText 			= question.QuestionText;
				 break;
			   }
		  }
		  
		  //Clear the responses that were already loaded
		  $('#divCompleteResponseView div.km-listview-wrapper').remove();
		  //Remove kendo combobox control alone
		  $('ul[id*="_"]').remove();
		  //Clear Other reasons control
		  $('div.OtherDiv').remove();
		  $('#spanQuestionText').text(questionText);
		  e.view.content.append('<ul id="ul_' + paramQuestionId + '"></ul>')
		  //$('#ResponseDetailContainer').append('<ul id="ul_' + paramQuestionId + '"></ul>');
		  
		  responseControlType = GetResponseControlType(responseControlTypeId);
		  var collResponses = JSON.parse(localStorage.getItem("CollectedResponses"));
		  var responseId, responseIdColl, responseText, canDisplayListView = false;
				
		  switch(responseControlType)
		  {
			case "radio": 
			case "checkbox": 
				//if a response is already made, mark it
				responseIdColl = GetUserResponse(paramQuestionId, "Id");
				responseText = GetUserResponse(paramQuestionId, "OtherText");
				responseText = responseText.replace(otherPrefix,"");
				
				var liText = "";
				var canCreateOtherTextBox = false;
				var responseIdArr = responseIdColl.split(",");
				var doesQuestionHaveResponse = false;
				
				for (var idx = 0; idx < responseForQuestion.length; idx++)
				{
						//if(responseId != undefined && responseId != "" && responseForQuestion[idx].ID == responseId){
						doesQuestionHaveResponse = CanCheckResponseId(responseForQuestion[idx].ID, responseIdArr);
						if(doesQuestionHaveResponse){
							liText = "<li><label> " + responseForQuestion[idx].Text + "<input type='" + responseControlType + "' name='input-" + paramQuestionId + "' id='"+ responseForQuestion[idx].ID+ "' checked='checked' class='textbox-"+ responseForQuestion[idx].OpensTextbox+ "'/></label></li>";						
						}
						else
						{
							liText = "<li><label> " + responseForQuestion[idx].Text + "<input type='" + responseControlType + "' name='input-" + paramQuestionId + "' id='"+ responseForQuestion[idx].ID+ "' class='textbox-"+ responseForQuestion[idx].OpensTextbox+ "'/></label></li>";						
						}
						
						if (!canCreateOtherTextBox){
							canCreateOtherTextBox = responseForQuestion[idx].OpensTextbox == true;
						}
						
						$("#ul_" + paramQuestionId).append(liText);
						//if(canCreateOtherTextBox && responseForQuestion[idx].ID == responseId){
						if(canCreateOtherTextBox && doesQuestionHaveResponse){ 
							$("#ul_" + paramQuestionId).after("<div class='OtherDiv'><input type='text' id='" + responseForQuestion[idx].ID + "-txtother'/></div>");							
							$('div.OtherDiv input').val(responseText);
						}
				}
				e.view.element.find("#ul_" + paramQuestionId).kendoMobileListView();
				
				break;
			case "select":
			//This will not be called anymore		
                if(false){
				var defaultEntry = JSON.parse('{"ID":-1,"Text":"","Description":"Select","OpensTextbox":false}');
				responseForQuestion.unshift(defaultEntry);
                $("#ul_" + question.ID).append("<li></li>");
				
					e.view.element.find("#ul_" + paramQuestionId + " > li").kendoComboBox({
													   dataTextField: "Text",
													   dataValueField: "ID",
													   dataSource: responseForQuestion,
													   filter: "contains",
													   suggest: true,
													   index: 0
													   });
													   
					$('#ul_' + paramQuestionId +' input').attr('placeholder', 'Please select/start typing an organization...');
					
					var combo = $("#ul_" + paramQuestionId +" li[data-role=combobox]").data("kendoComboBox");
					responseIdColl = GetUserResponse(paramQuestionId, "Id");
					combo.value(responseIdColl);
				}
				else{
					canDisplayListView = true;
					/*
					//listview
					var dataSource = new kendo.data.DataSource({ data: getResponses() });
					//$("#localListView").kendoMobileListView({
					//$("ul").kendoMobileListView({
					$("#ul_8").kendoMobileListView({
						dataSource: dataSource,
						template: "#: name #",
						virtualViewSize: 40, // needed setting, since local data virtualization does not use paging
						endlessScroll: true
					});
					*/
				}
				break;
		  }
		  
		  
		  if($('.textbox-true').attr("type") == "radio"){
			  //event to add textbox when 'Other' is clicked
			  $('.textbox-true').click(function(){							
					if($('div.OtherDiv input').attr('id') == undefined)
					{
						$(this).closest('ul').after("<div class='OtherDiv'><input type='text' id='" + $(this).attr('id') + "-txtother'/></div>")
						$('div.OtherDiv input').focus();
					}
				});
				$('.textbox-false').click(function(){										
											$('div.OtherDiv').remove();
				});
			}
		else if($('.textbox-true').attr("type") == "checkbox"){
			$('.textbox-true').click(function(){							
					if($('div.OtherDiv input').attr('id') == undefined)
					{
						if ($('.textbox-true').is(":checked")){
							$(this).closest('ul').after("<div class='OtherDiv'><input type='text' id='" + $(this).attr('id') + "-txtother'/></div>")
							$('div.OtherDiv input').focus();
						}
					}
					else
					{
						$('div.OtherDiv').remove();
					}
				});
			}
			
			if(canDisplayListView){
				app1.navigate("#LocalListView");
			}
			
		}
		
		function GetUserResponse(paramQuestionId, prop){
			var collResponses = JSON.parse(localStorage.getItem("CollectedResponses"));
			var retPropValue = "";
			
			if(collResponses.length > 0)
				{
					for (var idx = 0; idx < collResponses.length; idx ++){
						if (paramQuestionId == collResponses[idx].QuestionId)
						{
							switch(prop)
							{
								case "Id":
									retPropValue = collResponses[idx].ReasonId;
									break;
								case "OtherText":
									retPropValue = collResponses[idx].ReasonDetails;									
									break;
							}
							//responseIdColl = collResponses[idx].ReasonId;
							//responseText = collResponses[idx].ReasonDetails;
						}
					}
				}
				
				return retPropValue;
		}
		
		function CanCheckResponseId(responseId, responseIdArr){
			var didResponseIdMatch = false;
			
			for (var idx = 0; idx < responseIdArr.length; idx++)
			{
				if(responseId == responseIdArr[idx]){
					didResponseIdMatch = true;
					break;
				}
			}
			
			return didResponseIdMatch;
		}
		
		function GetResponseControlType(responseControlTypeId)
		{
			var responseControlType = "";
			
			switch(responseControlTypeId)
			  {
				case 1:
					responseControlType = "radio"
					break;
				case 2:
					responseControlType = "checkbox"
					break;
				case 3:
					responseControlType = "select"
					break;
				case 4:
					responseControlType = "textbox"
					break;
			  }
			
			return responseControlType;
		}
		
		function GetResponseType(questionId)
		{
			var retResponseType = "";
			//Get the questions that are loaded
			var questionsObj = JSON.parse(localStorage.getItem("questions"));
			var questions = questionsObj.Questions;
			for (var idx = 0; idx < questions.length; idx++)
			{
				if(questions[idx].ID == questionId){
					retResponseType = GetResponseControlType(questions[idx].ResponsesType);
					break;
				}
			}
			
			return retResponseType;
		}
        
        function CancelResponses(e)
        {
            window.location.href = "login.html";
        }
		
		function CollectResponse(e)
		{ //console.log("Collecting response...");
			try{
            var canSaveResponse = true;
			var responseType = GetResponseType(paramQuestionId);			
			var responseId = "";
			//Other checkbox			
			var isOther = false;			
			var otherText = "";			
			var collResponses = JSON.parse(localStorage.getItem("CollectedResponses"));
			var response, otherCtl, indivResponseId;
			
			for (var idx = 0; idx < collResponses.length; idx++)
			{
				response = collResponses[idx];				
				if (response.QuestionId == paramQuestionId)
				{
					switch(responseType)
					{
						case "radio":
						case "checkbox":
							//collect all the responses for checkbox/radio control
							$('input[name="input-'+ paramQuestionId + '"]:checked').each(function(){
                                indivResponseId = $(this).attr('id');
								responseId = responseId + indivResponseId + ",";
                                
                                otherCtl = $('#' + indivResponseId + '.textbox-true:checked');
                                isOther = otherCtl.attr('id') != undefined;
                                //console.log('indivresp..'+ indivResponseId + ' isOther..' + isOther + ' otherText..' + otherText)
                                if(isOther)
                                {
                                    otherText = $('#'+ indivResponseId +"-txtother").val();
                                }
							});
							
							if (responseId != "")
							{
								responseId = responseId.substring(0, responseId.length - 1);
                            }
						break;
						case "select":							
							responseId = $('input[name="input-' + paramQuestionId + '"]:checked').attr('id');
							otherText = "";
						break;
					}
					collResponses[idx].ReasonId = responseId;
					//collResponses[idx].ReasonDetails = otherText;
					var otherReasonId = "";
					if(otherText != "" && otherText != undefined){
						//OtherReasonId
						//var otherReasonId = $("div.OtherDiv input").attr('id');
						//otherReasonId = otherReasonId.replace("-txtother", "");
						collResponses[idx].OtherReasonId = responseId;//otherReasonId;
						collResponses[idx].ReasonDetails = otherPrefix + otherText.replace(otherPrefix, "");
					}
					else{
					  collResponses[idx].OtherReasonId = otherReasonId;
					  collResponses[idx].ReasonDetails = "";
					}
					
					break;
				}
			}
			
			
			
			localStorage.setItem("CollectedResponses", JSON.stringify(collResponses));
			
			if (isOther) //if other checkbox is enabled
			{
				if($.trim(otherText) == '')
				{
					//$("#" + responseId + "-txtother").addClass('Error').focus();
					$('div.OtherDiv input').addClass('Error').focus();
					canSaveResponse = false;
				}				
			}			
			
			if (canSaveResponse){
                //console.log('navigating back..');
				app1.navigate('#');
			}
            }
            catch(err){
                console.log('err occured..');
                console.log(err.message);
            }
		}
		
		//Test method
		function getResponses() {
			var data = [], idx = 0;			
			for (; idx < 1000; idx++) {
			
				data.push({
					name: "Name" + idx
				});
			}

			return data;
		}
		
		function getOrganizations(){
			var question, responseForQuestion, questionText;
		if(eventQuestions == undefined){ //if eventQuestions does not exist, parse it. eventQuestions should have been initialized in DisplayResponses methods			
			eventQuestions = JSON.parse(localStorage.getItem("questions"));
		  }
		  
		  var allQuestions = eventQuestions.Questions;
		  
		  for (var idx = 0; idx < allQuestions.length; idx++){
				question = allQuestions[idx];
			   if(question.ID == paramQuestionId)
			   {
				 //get responses
				 responseForQuestion	= question.Responses;
				 //responseControlTypeId 	= question.ResponsesType;
				 questionText 			= question.QuestionText;
				 break;
			   }
		  }
		  $('#spanQuestionText1').text(questionText);
		  
		  return responseForQuestion;
		}
        </script>
    </body>
</html>
